Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/jammy64"

  config.vm.network "private_network", ip: "192.168.56.82"
  config.vm.network "public_network"

  # VirtualBox provider settings
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "2048"
    vb.cpus = 2
  end

  # Provision Script
  config.vm.provision "shell", inline: <<-SHELL
    set -e

    # Update system
    sudo apt update -y

    # Install prerequisites
    sudo apt install -y ca-certificates curl gnupg lsb-release

    # Add Docker GPG key
    sudo install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo tee /etc/apt/keyrings/docker.asc > /dev/null
    sudo chmod a+r /etc/apt/keyrings/docker.asc

    # Add Docker repository
    echo "Types: deb
URIs: https://download.docker.com/linux/ubuntu
Suites: $(lsb_release -cs)
Components: stable
Signed-By: /etc/apt/keyrings/docker.asc" | sudo tee /etc/apt/sources.list.d/docker.sources

    sudo apt update -y

    # Install Docker
    sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

    sudo systemctl enable --now docker
sudo systemctl start docker

# Add vagrant user to docker group
  sudo usermod -aG docker vagrant

  # Create docker-compose file as vagrant user
  sudo -u vagrant bash -c 'cat > /home/vagrant/compose.yml << EOF
services:
  vprodb:
    image: vprocontainers/vprofiledb
    ports:
      - "3306:3306"
    volumes:
      - vprodbdata:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=vprodbpass

  vprocache01:
    image: memcached
    ports:
      - "11211:11211"

  vpromq01:
    image: rabbitmq
    ports:
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest

  vproapp:
    image: vprocontainers/vprofileapp
    ports:
      - "8080:8080"
    volumes:
      - vproappdata:/usr/local/tomcat/webapps

  vproweb:
    image: vprocontainers/vprofileweb
    ports:
      - "80:80"

volumes:
  vprodbdata: {}
  vproappdata: {}
EOF'
sudo -u vagrant bash -c 'cat > /home/vagrant/stop.sh << "EOF"
#!/bin/bash

# Stop and remove containers created by compose
docker compose -f /home/vagrant/compose.yml down

# Stop any other running containers
docker ps -q | xargs -r docker stop

# Remove ALL containers
docker ps -aq | xargs -r docker rm -f

# Remove ALL images (correct: column is image ID)
docker images -q | xargs -r docker rmi -f

echo "All Docker containers and images have been removed."
EOF'

  # Let vagrant use docker immediately
  newgrp docker <<EONG
    docker compose -f /home/vagrant/compose.yml up -d
EONG
SHELL
end
